# Котнейнеризированное Django приложение

## Спецификация

**Вам нужно создать новые эндпоинты API, позволяющие пользователю выполнять следующие действия:**

- Создавать новых собак, отправляя POST-запрос на `/api/dogs/`
- Получать список всех сохраненных собак, отправляя GET-запрос на `/api/dogs/`
- Получать, модифицировать или удалять существующую запись о собаке, отправляя GET, PUT или DELETE-запрос соответственно на `/api/dogs/<id>`, где `id` - это идентификатор записи о собаке
- Поскольку у собаки есть внешний ключ на породу, вам также нужно создать аналогичные конечные точки для пород собак по адресам `/api/breeds/` и `/api/breeds/<id>`

### Модель Dog

**Собака должна содержать следующие поля:**

- name (строка символов)
- age (целое число)
- breed (внешний ключ к модели Breed)
- gender (строка символов)
- color (строка символов)
- favorite_food (строка символов)
- favorite_toy (строка символов)

### Модель Breed

**Порода должна содержать следующие поля:**

- name (строка символов)
- size (строка символов) [должно принимать значения Tiny, Small, Medium, Large]
- friendliness (поле целого числа) [должно принимать значения от 1 до 5]
- trainability (поле целого числа) [должно принимать значения от 1 до 5]
- shedding_amount (поле целого числа) [должно принимать значения от 1 до 5]
- exercise_needs (поле целого числа) [должно принимать значения от 1 до 5]

### Тщательно протестируйте ваши эндпоинты API Dog и Breed

**Для модели Dog:**

- *GET* (список) на `/api/dogs/` - должен включать информацию о среднем возрасте собак каждой породы.
- *POST* на `/api/dogs/`
- *GET* на `/api/dogs/<id>` - должен включать количество собак той же породы.
- *PUT* на `/api/dogs/<id>`
- *DELETE* на `/api/dogs/<id>`

**Для модели Breed:**

- *GET* (список) на `/api/breeds/` - должен включать количество собак каждой породы.
- *POST* на `/api/breeds/`
- *GET* на `/api/breeds/<id>`
- *PUT* на `/api/breeds/<id>`
- *DELETE* на `/api/breeds/<id>`

***При выполнении этих запросов убедитесь, что реализованы подзапросы или использование OuterRef для получения связанной информации без повторного обращения к базе данных.***

**Это особенно важно для следующих случаев:**

- При получении списка собак (`/api/dogs/`) должна быть включена информация о среднем возрасте собак данной породы.
- При получении информации о конкретной собаке (`/api/dogs/<id>`) должно быть указано количество собак той же породы.
- При получении списка пород (`/api/breeds/`) должно быть указано количество собак каждой породы.

### Требования к реализации

1. **Структура проекта**
    - Проект должен быть структурирован в соответствии с лучшими практиками Django.
    - Все необходимые файлы должны быть размещены в соответствующих директориях.
2. **Модели**
   - Создать модели `Dog` и `Breed` в файле `models.py`.
   - Модели должны соответствовать спецификации, указанной в задании.
   - Использовать подходящие типы полей Django ORM.
3. **API ViewSets**
   - Реализовать классы `DogViewSet` и `BreedViewSet` в файле `views.py`.
   - Каждый ViewSet должен содержать методы для обработки *GET*, *POST*, *PUT* и *DELETE* запросов.
   - Использовать Django Rest Framework для создания API.
4. **URL конфигурация**
    - Создать файл `urls.py` с правильной маршрутизацией для всех конечных точек API.
    - Использовать роутеры DRF для автоматической генерации URL-паттернов.
5. **Документация кода**
    - Все классы, функции и методы должны быть документированы с помощью docstrings.
    - Docstrings должны соответствовать стандарту Google Python Style Guide.
    - Описывать параметры, возвращаемые значения и возможные исключения.
6. **Стиль кода**
    - Соблюдать PEP-8 стиль кодирования.
    - Максимальная длина строки не должна превышать 119 символов.
    - Использовать линтер и/или форматтер (например, *flake8* или *ruff*) для проверки соблюдения стилевых правил.
7. **Docker контейнеризация**
    - Создать `Dockerfile` для сборки образа приложения.
    - Написать `docker-compose.yml` файл для управления сервисами (Django и PostgreSQL).
    - Убедиться, что приложение корректно работает внутри Docker-контейнера.
8. **Подзапросы и оптимизация**
   - Реализовать требуемые подзапросы или использование `OuterRef` для получения дополнительной информации:
        - Средний возраст собак данной породы при получении списка собак.
        - Количество собак той же породы при получении информации о конкретной собаке.
        - Количество собак каждой породы при получении списка пород.
9. **Версионирование**
    - Использовать систему контроля версий Git.
    - Создавать отдельную ветку для разработки (например, `feature/dog-api`).
    - Делать коммиты регулярно с осмысленными сообщениями.
10. **Зависимости**
    - Использовать `requirements.txt` для управления зависимостями проекта.
    - Указывать версии используемых библиотек.
11. **Настройки окружения**
    - Использовать `.env` файл для хранения конфиденциальных данных и переменных окружения.
    - Создать пример файла `.env.example` с описанием необходимых переменных.
12. **README.md**
    - Создать `README.md` файл с инструкцией по установке и запуску проекта.
    - Описать основные компоненты проекта и его архитектуру.
    - Предоставить примеры использования API.

## Реализация

### Запуск проекта

Приложение упаковано в докер-контейнеры, описанные в `docker-compose.yaml`. Перед сборкой и запуском необходимо создать в корне проекта (на одном уровне с docker-compose.yaml) файл с переменными окружения `.env`. Его необходимо заполнить по образцу из `.env.example`. Сам .example файл не нужен для работы приложения. Можно просто исправить его наименование (удалить подстроку *.example*) и подставить свои значения для каждой переменной.

Порядок запуска:

- Установка значений переменных окружения в файле `.env`
- Сборка и запуск контейнеров командой `docker compose up --build`. Эту команду нужно выполнить из корневой директории проекта (там, где лежит *.env*). Проект запустится в активном окне терминала с выводом логов в консоль.
Для запуска контейнеров в *detach* режиме используй команду `docker compose up -d --build`. Это позволить поднять контейнеры и закрыть сессию терминала или соединение с удаленным сервером, на котором запускается проект.
- После сборки контейнеров применяются все существующие миграции, создается суперпользователь и запускается сервер разработки django.
- API Root URLs доступны по адресу [`http://0.0.0.0:8000/api/`](http://0.0.0.0:8000/api/)

### Архитектура проекта

### app_auth

Это приложение используется только для *manager command* создания суперпользователя при первом запуске проекта. Имя пользователя и пароль по умолчанию задаются как `admin` `admin`. Ты можешь управлять установкой логина и пароля суперпользователя через переменные окружения `DJANGO_SUPERUSER_USERNAME` и `DJANGO_SUPERUSER_PASSWORD`.

### app_dogs

Здесь реализована вся спецификация.

- Взаимодействие с базой данных осуществляется при помощи django ORM. Классы моделей описаны в файле `app_dogs/models.py`
- Сериализация данных происходит в DRF сериализаторах (`app_dogs/serializers.py`)
- Логика получения данных из БД и отдача их клиенту реализована в DRF ModelViewSet (`app_dogs/views.py`). Здесь же выполняется аннотация django QuerySet вычисляемыми полями и оптимизация количества запросов к БД при помощи таких методов как `select_related` и `prefetch_related`.
- При помощи роутеров DRF происходит автоматическая генерация URL-паттернов всех CRUD методов (`app_dogs/urls.py`)
- Тестирование работы сериализаторов и API средствами django и DRF добавлено в директорию `app_dogs/tests/`. Запуск тестов проще всего выполнять в докере. После старта контейнеров запусти тесты вручную командой `docker exec -it django python manage.py test`. Корректный вывод в консоли будет примерно следующий:

  ```bash
  $ docker exec -it django python manage.py test

  Found 14 test(s).
  Creating test database for alias 'default'...
  System check identified no issues (0 silenced).
  ..............
  ----------------------------------------------------------------------
  Ran 14 tests in 0.065s

  OK
  Destroying test database for alias 'default'...
  ```

  - `test_api_breeds.py` - проверка всех методов из спецификации *Breed*. Сравнение ожидаемых значений с получаемыми клиентом из БД. Тесты написаны на основе DRF APITestCase.
  - `test_api_dogs.py` - проверка всех методов из спецификации *Dog*. Сравнение ожидаемых значений с получаемыми клиентом из БД. Тесты написаны на основе DRF APITestCase.
  - `test_serializers.py` - проверка работы сериализторов. Сравнение ожидаемых сериализованных значений после применения кастомных сериализаторов к данным, полученным из БД. Тесты написаны на основе django TestCase.

### База данных

Для хранения данных используется база данных **postgres 15**. На момент разработки сервиса это последняя версия postgres, протестированная командой django.
База поднимается в докер контейнере, инструкции описаны в файле `docker-compose.yaml` в разделе сервиса `postgres`. Подключение джанго-приложения к БД осуществлено в докер-сети. Настройки подключения задаются в файле `project/settings.py`:

```python
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.postgresql",
        "HOST": getenv("PG_HOST", ""),
        "PORT": getenv("PG_PORT", ""),
        "NAME": getenv("PG_DB_NAME", ""),
        "USER": getenv("PG_USER", ""),
        "PASSWORD": getenv("PG_PASSWORD", ""),
        "OPTIONS": {
            "isolation_level": IsolationLevel.REPEATABLE_READ,
        },
    }
}
```

Значения переменных окружения подставляются те, которые указаны в `.env` файле.

### Примеры использования API

#### root

- request: *GET* <http://0.0.0.0:8000/api/>

    response: *200 OK*

    ```json
    {
        "dogs": "http://0.0.0.0:8000/api/dogs/",
        "breeds": "http://0.0.0.0:8000/api/breeds/"
    }
    ```

#### API dogs

- request: *GET* <http://0.0.0.0:8000/api/dogs/>

    resoinse: *200 OK*

    ```json
    {
        "count": 3,
        "next": null,
        "previous": null,
        "results": [
            {
                "id": 1,
                "name": "Admiral",
                "age": 2,
                "gender": "male",
                "detail_url": "http://0.0.0.0:8000/api/dogs/1/",
                "breed_avg_age": 2.0
            },
            {
                "id": 2,
                "name": "Alice",
                "age": 1,
                "gender": "female",
                "detail_url": "http://0.0.0.0:8000/api/dogs/2/",
                "breed_avg_age": 2.0
            },
            {
                "id": 3,
                "name": "Lucia",
                "age": 3,
                "gender": "female",
                "detail_url": "http://0.0.0.0:8000/api/dogs/3/",
                "breed_avg_age": 2.0
            }
        ]
    }
    ```

- request: *POST* <http://0.0.0.0:8000/api/dogs/>

    ```json
    {
        "name": "Bobby",
        "age": 1,
        "gender": "male"
    }
    ```

    response: *201 Created*

    ```json
    {
        "id": 4,
        "name": "Bobby",
        "age": 1,
        "gender": "male",
        "breed": null,
        "color": "other",
        "favorite_food": null,
        "favorite_toy": null
    }
    ```

- request *GET* <http://127.0.0.1:8000/api/dogs/1/>

    response: *200 OK*

    ```json
    {
        "id": 1,
        "name": "Admiral",
        "age": 2,
        "gender": "male",
        "breed": 1,
        "color": "other",
        "favorite_food": null,
        "favorite_toy": null,
        "same_breed_count": 1
    }
    ```

- request *PUT* <http://127.0.0.1:8000/api/dogs/1/>

    ```json
    {
        "name": "Admiral Benbow",
        "age": 2,
        "color": "dark gray",
        "favorite_food": "lamb",
        "favorite_toy": "neighbor's leg"
    }
    ```

    response: *200 OK*

    ```json
    {
        "id": 1,
        "name": "Admiral Benbow",
        "age": 2,
        "gender": "male",
        "breed": 1,
        "color": "dark gray",
        "favorite_food": "lamb",
        "favorite_toy": "neighbor's leg"
    }
    ```

- requets *DELETE* <http://0.0.0.0:8000/api/dogs/4/>

    response: *204 No Content*
